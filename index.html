<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
      integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
      crossorigin=""></script>

    <link rel="stylesheet" href="css/main.css">
  </head>

  <body>
    <!-- map goes here -->
    <div id="mapid"></div>

    <script type="text/javascript" src="data/vancouver.js"></script>
    <script type="text/javascript" src="data/surrey.js"></script>
    <script type="text/javascript" src="data/richmond.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script>
      var mymap = L.map('mapid').setView([49.2827, -123.1207], 11);
      var color = d3.scaleQuantize()
                  .range(['#fff7fb','#ece7f2','#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#034e7b']);

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.light',
          accessToken: 'pk.eyJ1IjoiZWl2YW5uaXNwZXJvcyIsImEiOiJjamV4YTdnM2ExMHVoMndwY2N6ZGk2M3BsIn0.Ga6sMTa39-B_DchNNMKBwA'
      }).addTo(mymap);


      // function style(feature) {
      //
      //   color.domain([
      //     	d3.min(feature, function(d) { return d.value; }),
      //       d3.max(feature, function(d) { return d.value; })
      //   ]);
      //
      //   d3.csv("data/med_avg_income_vanc.csv", function(income) {
      //     for (var i = 0; i < )
      //   });
      //
      //   return {
      //     fillColor: color, //data needs to go in here
      //     weight: 2,
      //     opacity: 1,
      //     color: 'white',
      //     dashArray: '3',
      //     fillOpactiy: 0.7
      //   }
      // }

      d3.csv("data/us-ag-productivity.csv", function(data) {
        //sets scale for color
        color.domain([
					d3.min(data, function(d) { return d.value; }),
					d3.max(data, function(d) { return d.value; })
				]);

        d3.json(vancNeighborhoods, function(json) {
          for (var i = 0; i < data.lenght; i++) {
            //take name of neighborhood in JSON
            var vancNeighName = data[i].state;
            console.log(vancNeighName);

            //avg income in CSV
            var vancNeighAvgValue = parseFloat(data[i].avgIncome);

            //find corresponding vnacouver neighborhood inside the GEOJSON
            for (var j = 0; j < json.features.lenght; j++) {
              var jsonVancName = json.features[j].properties.name;

              //place it inside
              if (vancNeighName == jsonVancName) {
                json.features[j].properties.value = vancNeighAvgValue;
                break;
              }
            }

          }

          function style(d) {
            return {
                fillColor: color(d.properties.value),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
          }

          L.geoJSON(vancNeighborhoods, {style: style}).addTo(mymap);
        });

      });


      //layers
      // L.geoJSON(vancNeighborhoods).addTo(mymap);
      L.geoJSON(surreyNeighborhoods).addTo(mymap);

      L.svg().addTo(mymap);

      //color


      var svg =  d3.select("#mapid").select("svg");
      var g = svg.select("g").attr("class", "leaflet-zoom-hide");

      d3.csv("data/vancouver_schools.csv", function(error, data) {
        data.forEach(function (d) {
            d.LatLng = new L.LatLng(d.LATITUDE, d.LONGITUDE);
        })

        var feature = g.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("r", 5)
            .attr("fill", "red")
            .style("stroke", "black")

        function update() {
            feature.attr("cx", function (d) {
              return mymap.latLngToLayerPoint(d.LatLng).x;
            });

            feature.attr("cy", function (d) {
              return mymap.latLngToLayerPoint(d.LatLng).y;
            });
        }

        mymap.on("viewreset", update);
        mymap.on("zoomend", update);
        update();
      });
    </script>

  </body>
</html>
