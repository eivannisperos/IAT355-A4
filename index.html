<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin=""/>

    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/tipsy.js"></script>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
      integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
      crossorigin=""></script>

    <link rel="stylesheet" href="css/main.css">
  </head>

  <body>
    <!-- map goes here -->
    <div id="mapid"></div>

    <script type="text/javascript" src="data/vancouver.js"></script>
    <script type="text/javascript" src="data/surrey.js"></script>
    <script type="text/javascript" src="data/richmond.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script>
      var mymap = L.map('mapid').setView([49.2827, -123.1207], 12.5);

      //radius of circle
      var radius = 7;
      var colorVacc = d3.scaleQuantize()
        .range(['#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02','#a6761d','#666666']);

      //active listeners
      var geojson;

      //information bar
      var info = L.control();

      //legend
      var legend = L.control({position: 'bottomright'});

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox.light',
          accessToken: 'pk.eyJ1IjoiZWl2YW5uaXNwZXJvcyIsImEiOiJjamV4YTdnM2ExMHVoMndwY2N6ZGk2M3BsIn0.Ga6sMTa39-B_DchNNMKBwA'
      }).addTo(mymap);

      //reset highlight feature
      function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 5,
          color: '#ccc',
          dashArray: '',
          fillOpactiy: 0.7
        });

        //updates the info control with actual info
        //in this case, this is median household income
        info.update(layer.feature.properties);
      }

      //resets default style
      function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
      }

      //zooms to neighborhood when clicked
      function zoomToFeature(e) {
        mymap.fitBounds(e.target.getBounds());
      }

      //for each listener, add the action required
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: zoomToFeature
        });
      }

      //control (overlay showing data)

      //creates a div with info as a class
      info.onAdd = function(mymap) {
        this._div = L.DomUtil.create('div', 'info'); //create a div with info as a class
        this.update();
        return this._div;
      }

      //puts the information inside the div
      info.update = function(props) {
        this._div.innerHTML = '<h3>Median Household Income By Neighborhood</h3>' + (props ? '<b>' + props.name + '</b><br />' + "$" + " " + props.value : 'Hover over a Neighborhood');
      }

      info.addTo(mymap);

      //school labels
      schoolLabel.onAdd = function(mymap) {
        this._div = L.DomUtil.create('div', 'info'); //create a div with info as a class
        schoolLabel.update();
        return this._div;
      }

      schoolLabel.addTo(mymap);

      //handles vancouver chloropleth
      d3.csv("data/med_avg_income_vanc.csv", function(data) {

        for (var i = 0; i < data.length; i++) {
          //take name of neighborhood in JSON
          var vancNeighName = data[i].name;
          //avg income in CSV
          var vancNeighAvgValue = parseFloat(data[i].avgIncome);

          //find corresponding vnacouver neighborhood inside the GEOJSON
          for (var j = 0; j < vancNeighborhoods.features.length; j++) {
            var jsonVancName = vancNeighborhoods.features[j].properties.name;

            //place it inside
            if (vancNeighName == jsonVancName) {
              vancNeighborhoods.features[j].properties.value = vancNeighAvgValue;
              break;
            }
          }

        }

        //median household income color scheme
        function getColorMedHaus(d) {
          return d > 70000  ? '#034e7b' :
                 d > 60000  ? '#0570b0' :
                 d > 50000  ? '#3690c0' :
                 d > 40000  ? '#74a9cf' :
                 d > 35000  ? '#a6bddb' :
                 d > 30000  ? '#d0d1e6' :
                           'white';
        }

        function style(vNeigh) {
          return {
              fillColor: getColorMedHaus(vNeigh.properties.value),
              weight: 2,
              opacity: 1,
              color: 'white',
              dashArray: '3',
              fillOpacity: 0.7
          };
        }

        //add legend
        legend.onAdd = function(mymap) {
          //each div has a class with info and legend

          var div = L.DomUtil.create('div', 'info legend'),
          grades = [30000, 35000, 40000, 50000, 60000, 70000],
          labels = [];

          for (var i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + getColorMedHaus(grades[i] + 1) +  '"></i> '
            + grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '</br>' : '+');
          }

          return div;
        }

        legend.addTo(mymap);

        //for the geoJSON, add the JSON, the new stying, and the listeners to the layer
        geojson = L.geoJSON(vancNeighborhoods, {style: style, onEachFeature: onEachFeature}).addTo(mymap);
      });


      //layers
      L.geoJSON(surreyNeighborhoods).addTo(mymap);


      var svg =  d3.select("#mapid").select("svg");
      var g = svg.select("g").attr("class", "leaflet-zoom-hide");



      d3.csv("data/vanc_full_data_elem.csv", function(error, data) {
        var popUp;

        data.forEach(function (d) {
            d.LatLng = new L.LatLng(d.LATITUDE, d.LONGITUDE);
        })

        function getColorVacc(d) {
          return d > 90  ? '#fef0d9' :
                 d > 85  ? '#fdd49e' :
                 d > 80 ? '#fdbb84' :
                 d > 70  ? '#fc8d59' :
                 d > 60  ? '#e34a33' :
                 d > 50  ? '#b30000' :
                           'white';
        }


        //mouse events function when hovering over dots
        function handleMouseOver(d, i) {
          var name = d.schoolName;

          var lat = parseFloat(d.LATITUDE);
          var long = parseFloat(d.LONGITUDE);

          console.log(d.schoolName);
          console.log(parseFloat(d.LATITUDE));
          console.log(parseFloat(d.LONGITUDE));

          // popUp = L.popup()
          //   .setLatLng([lat, long])
          //   .setContent(d.schoolName)
          //   .openOn(mymap);
          schoolLabel.update = function(props) {
            this._div.innerHTML = '<h3>Median Household Income By Neighborhood</h3>' + (props ? '<b>' + name + '</b><br />' : 'Hover over a School');
          }


          d3.select(this).attr("r", radius * 4);

        }


        function handleMouseOut(d) {
          d3.select(this).attr("r", radius);
        }

        var feature = g.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("r", radius)
            .style("fill", function(d) {
              var value = parseFloat(d.MEASLES);

              if (value) {
                return getColorVacc(value);
              } else {
                return "white";
              }
            })
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);

        function update() {
            feature.attr("cx", function (d) {
              return mymap.latLngToLayerPoint(d.LatLng).x;
            });

            feature.attr("cy", function (d) {
              return mymap.latLngToLayerPoint(d.LatLng).y;
            });
        }

        mymap.on("viewreset", update);
        mymap.on("zoomend", update);
        update();
      });
    </script>

  </body>
</html>
